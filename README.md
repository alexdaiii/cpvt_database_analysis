# CPVT Database Analysis

This repository contains the code used to analyze the CPVT database and generate figures and tables
for the manuscript "RYR2 Variant Location and Age of Onset in Catecholaminergic Polymorphic Ventricular Tachycardia - A
systematic review and meta-analysis of case-based literature".

## Data

The data used in this analysis is available in [Zenodo](https://zenodo.org/doi/10.5281/zenodo.8277761). It requires
a PostgreSQL database to be loaded. Download the `*.gz.sql` and `*.sql` files and place them in the `init` directory
relative to the root of this repository.

A quick way to load the data is to use the `docker-compose.yaml` file in the
main directory. It assumes that you have Docker and Docker Compose installed. Instructions for installing Docker and
Docker Compose can be found on [Docker's website](https://docs.docker.com/engine/install/).

This configuration will mount
the `init` directory to `/docker-entrypoint-initdb.d` in the PostgreSQL container, which will load the data
when the container is started (assuming that the database is empty) and create a volume for the database data.
The database will be available at `localhost:5432`.

Also,`pgadmin` is started to allow you to interact with the database, which will be available
at [http://localhost:5050](http://localhost:5050).

To start the database (with the terminal detached), run:

```bash
docker-compose up -d
```

Currently, the database will take a little over 4GB of space, since it contains all the rows from the
original `biocommons/UTA`
database. A version with just the RYR2 gene using instructions from the [Rust hgvs crate](https://crates.io/crates/hgvs)
is in the works.

## Requirements

### Poetry

This project uses [Poetry](https://python-poetry.org/) to manage dependencies. To install the dependencies, run:

```bash
poetry install
```

### Pip

Alternatively, you can use `pip` to install the dependencies. To do so, run:

```bash
pip install -r requirements.txt
```

### Issues with psycopg

The `hgvs` package requires the `psycopg2` package to be installed. `psycopg2` requires PostgreSQL to be installed on
your system.
If you don't have PostgreSQL installed, you can use Docker+Postgres and the `psycopg2-binary` package instead.
If you encounter issues with installing `psycopg`, you can install the `hgvs` package with the following commands:

```bash
poetry install --no-root
poetry add hgvs || echo "This will fail, but will install the dependencies"
# activate the virtual environment and run the remaining commands in a subshell
( \
    . $$(poetry env info --path)/bin/activate; \
    pip install psycopg2-binary; \
    pip install --no-deps hgvs;
)
# reinstall deps again that were overwritten by the previous commands
poetry install --no-root
```

## R Requirements

The R code is in a Jupyter notebook. If you aren't using Anaconda, you can install the required
packages by following the instructions on
this [DataCamp blog post](https://www.datacamp.com/blog/jupyter-and-r-markdown-notebooks-with-r).

If you don't want to use Jupyter notebooks, you can copy the R code from the notebooks and run it in an R script or
a Rmd file.

### R Packages

You can run the `install.R` script in r_notebooks to install the required packages:

```bash
Rscript r_notebooks/install.R
```

## Descriptions of the Python Notebooks

These are in the `notebooks` directory. These are Python Jupyter notebooks. These notebooks will automatically
create a `data` and `figures` directory in the root of the repository to store the data and figures generated by the
notebooks.

All of these notebooks require the PostgreSQL database to be loaded with the data.

- helpers
    - packages for loading env variables and other helper functions
    - The `settings.py` file expects a .env file in the root directory with the variables listed in the `.env.example`
      file
        - If no variables are provided, it will use the default values
- analysis_1
    - This notebook contains the code to generate the age of onset vs variant location (exon, domain, subdomain) plots
      and perform analysis
    - Performs the Kruskal-Wallis test and Dunn's post-hoc test to determine if there are significant differences
      between the groups
    - It also exports the data on age of onset vs variant location for the `analysis_2.r` notebook for follow-up
      analysis
- analysis_2
    - This notebook contains the code to plot the demographics of the patients in the database
    - It also exports the data about treatments given to patients for the `analysis_1.r` notebook
- analysis_5
    - This notebook contains the code to generate tables for the manuscript
- create_tabular_database
    - This notebook creates an excel file with the data from the database. Converts the m-n relationships into pivot
      tables

### Unused Notebooks

- analysis_3
    - Number of variants that can be converted to genomic/protein coordinates
- analysis_4
    - Attempts to fit a GLM with a Gamma distribution to the age of onset data. Not used in the manuscript.

## Descriptions of the R Notebooks

These are in the `r_notebooks` directory. These are R Juptyer notebooks.

- analysis_1
    - Performs the pairwise Fisher's exact test for the treatments given to patients with variants in different
      locations
    - Requires: the data from the `analysis_2` notebook to be exported to a CSV file before running
- analysis_2
    - Calculates some effect sizes for age of onset vs variant location (unused in the manuscript since we just report
      the
      median and IQR)
    - Requires: the data from the `analysis_1` notebook to be exported to a CSV file before running
